<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Microfinance Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="container mx-auto">
    <h1 class="text-3xl font-bold mb-4">Micro-Finance Dashboard</h1>
    <div class="mb-4">
      <label for="member" class="block mb-1 font-semibold">Select Member</label>
      <select id="member" class="p-2 rounded border w-64">
        <option value="">-- Choose Member --</option>
        <script>
          for (let i = 2; i <= 11; i++) {
            document.write(`<option value="Sheet${i}">Member ${i - 1}</option>`);
          }
        </script>
      </select>
    </div>
    <div id="table-container" class="overflow-x-auto bg-white p-4 rounded shadow"></div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxgj5JpER0nbChrZ7_kkLMFPC_bzBlGCcXrrkrYiq9I1M1_9ZxCHKs_QUYy6H6oNflq8Q/exec'; // Replace this!

    document.getElementById('member').addEventListener('change', function () {
      const sheetName = this.value;
      if (sheetName) {
        fetchData(sheetName);
      }
    });

    async function fetchData(sheetName) {
      const res = await fetch(`${API_URL}?action=read&sheetName=${sheetName}`, { method: 'POST' });
      const data = await res.json();
      renderTable(data, sheetName);
    }

    function renderTable(data, sheetName) {
      const table = document.createElement('table');
      table.className = 'min-w-full divide-y divide-gray-200 text-sm';

      const headers = [
        "month", "savings", "profit", "withdraw", "total", "loan", "instalment", 
        "instalment_no", "instalment_due", "receive_date", "receiver", "message", "id", "actions"
      ];

      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>${headers.map(h => `<th class="px-3 py-2 text-left bg-gray-100">${h}</th>`).join('')}</tr>`;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
          if (h === 'actions') {
            tr.innerHTML += `
              <td class="px-3 py-2 space-x-2">
                <button class="text-blue-500" onclick='editRow(${JSON.stringify(row)}, "${sheetName}")'>Edit</button>
                <button class="text-red-500" onclick='deleteRow("${row.id}", "${sheetName}")'>Delete</button>
              </td>`;
          } else {
            tr.innerHTML += `<td class="px-3 py-2">${row[h] || ''}</td>`;
          }
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      document.getElementById('table-container').innerHTML = '';
      document.getElementById('table-container').appendChild(table);
    }

    async function deleteRow(id, sheetName) {
      if (confirm('Delete this entry?')) {
        await fetch(`${API_URL}?action=delete&sheetName=${sheetName}&id=${id}`, { method: 'POST' });
        fetchData(sheetName);
      }
    }

    function editRow(row, sheetName) {
      const formHtml = Object.keys(row).map(key => `
        <label class="block mt-2">${key}<input class="w-full border p-1" name="${key}" value="${row[key] || ''}"></label>
      `).join('');
      const form = document.createElement('form');
      form.innerHTML = formHtml + `<button class="mt-4 bg-blue-500 text-white px-4 py-2 rounded" type="submit">Save</button>`;
      form.onsubmit = async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams([...formData.entries()]);
        params.append('action', 'update');
        params.append('sheetName', sheetName);
        await fetch(`${API_URL}`, { method: 'POST', body: params });
        fetchData(sheetName);
      };
      document.getElementById('table-container').innerHTML = '';
      document.getElementById('table-container').appendChild(form);
    }
  </script>
</body>
</html>
