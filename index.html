<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Micro‑Finance App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-7xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">Micro‑Finance Dashboard</h1>
    <label>Select Member:
      <select id="memberSelect" class="border p-2 rounded">
        ${Array.from({length:10}, (_,i)=>`<option value="${i+1}">Member ${i+1}</option>`).join('')}
      </select>
    </label>

    <div class="overflow-x-auto mt-4">
      <table class="min-w-full bg-white shadow rounded">
        <thead>
          <tr class="bg-blue-500 text-white">
            ${["month","savings","profit","withdraw","total","loan","instalment","instalment_no","instalment_due","receive_date","receiver","message","actions"].map(h=>`<th class="p-2">${h.replace('_',' ')}</th>`).join('')}
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="formContainer" class="mt-4 bg-white shadow rounded p-4 hidden">
      <h2 class="text-xl font-semibold mb-2">Record</h2>
      <form id="recordForm" class="grid grid-cols-2 gap-4">
        ${["id","month","savings","profit","withdraw","total","loan","instalment","instalment_no","instalment_due","receive_date","receiver","message"].map(f=>`
        <div class="col-span-1">
          <label class="block font-medium">${f.replace('_',' ')}</label>
          <input name="${f}" id="field_${f}" class="w-full border p-2 rounded"/>
        </div>`).join('')}
        <div class="col-span-2 flex justify-end space-x-2">
          <button type="button" id="createBtn" class="bg-green-500 text-white px-4 py-2 rounded">Create</button>
          <button type="button" id="updateBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hidden">Update</button>
          <button type="button" id="cancelBtn" class="bg-gray-400 text-white px-4 py-2 rounded hidden">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = '<<https://script.google.com/macros/s/AKfycbzOrvXr1L0cyhPgtcLzxicR7H0c4Zm8xbZGH04p6_H0tAegJ-ddlgOT4XP98sYVUVEjKw/exec>>';
    const memberSelect = document.getElementById('memberSelect');
    const tableBody = document.getElementById('tableBody');
    const formC = document.getElementById('formContainer');
    const form = document.getElementById('recordForm');
    const createBtn = document.getElementById('createBtn');
    const updateBtn = document.getElementById('updateBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    let editingId = null;

    memberSelect.addEventListener('change', fetchAndRender);
    createBtn.addEventListener('click', () => submitForm('create'));
    updateBtn.addEventListener('click', () => submitForm('update'));
    cancelBtn.addEventListener('click', () => resetForm());

    async function api(action, data={}) {
      const params = new URLSearchParams({action, member: memberSelect.value});
      Object.entries(data).forEach(([k,v])=> params.append(k,v || ''));
      const res = await fetch(API_URL, {method:'POST', body: params});
      return res.json();
    }

    function fetchAndRender(){
      resetForm();
      api('read').then(data => {
        tableBody.innerHTML = data.map(r => `
          <tr class="border-b">
            ${["month","savings","profit","withdraw","total","loan","instalment","instalment_no","instalment_due","receive_date","receiver","message"].map(f=>`<td class="p-2">${r[f]||''}</td>`).join('')}
            <td class="p-2 space-x-1">
              <button class="bg-blue-500 text-white px-2 py-1 rounded" onclick="edit('${r.id}')">Edit</button>
              <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="del('${r.id}')">Delete</button>
            </td>
          </tr>`).join('');
      });
    }

    function edit(id) {
      api('read').then(data => {
        const row = data.find(r => r.id == id);
        if (!row) return;
        editingId = id;
        Object.keys(row).forEach(f => {
          const fld = document.getElementById('field_'+f);
          if (fld) fld.value = row[f];
        });
        formC.classList.remove('hidden');
        createBtn.classList.add('hidden');
        updateBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
      });
    }

    function del(id) {
      if (!confirm('Delete record?')) return;
      api('delete',{id}).then(fetchAndRender);
    }

    function resetForm() {
      editingId = null;
      form.reset();
      formC.classList.add('hidden');
      createBtn.classList.remove('hidden');
      updateBtn.classList.add('hidden');
      cancelBtn.classList.add('hidden');
    }

    function submitForm(action) {
      const data = {};
      new FormData(form).forEach((v,k) => data[k] = v);
      api(action, data).then(fetchAndRender);
    }

    // auto-load
    fetchAndRender();
  </script>
</body>
</html>
