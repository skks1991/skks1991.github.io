<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF‑8">
  <meta name="viewport" content="width=device‑width, initial‑scale=1.0">
  <title>Micro‑Finance Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">Micro‑Finance Dashboard</h1>
  <div class="mb-4">
    <label class="block mb-1">Select Member:</label>
    <select id="memberSelect" class="border p-2 rounded">
      <option disabled selected>— Choose —</option>
      <script>
        for(let i=1;i<=10;i++){
          document.write(`<option value="Member${i}">Member ${i}</option>`);
        }
      </script>
    </select>
  </div>

  <div id="tableContainer"></div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx38W2nHLfcFgTKDrODF7dA_hd9GzsrLPMvkQSBtOviz6lT3MHNrG9AeOZ7pIrOC9Ri/exec';

    const memberSelect = document.getElementById('memberSelect');
    const tableContainer = document.getElementById('tableContainer');
    let currentMember = null;
    let currentData = [];

    memberSelect.addEventListener('change', async () => {
      currentMember = memberSelect.value;
      await fetchData();
      renderTable();
    });

    async function fetchData(){
      const params = new URLSearchParams({
        action:'read',
        member: currentMember
      });
      const res = await fetch(WEB_APP_URL, { method:'POST', body: params });
      currentData = await res.json();
    }

    function renderTable(){
      const html = `
        <button id="addBtn" class="mb-2 px-4 py-2 bg-green-500 text-white rounded">+ Add Entry</button>
        <table class="min-w-full bg-white shadow rounded">
          <thead class="bg-gray-200">
            <tr>${['Month','Savings','Profit','Withdraw','Total','Loan','Instalment','Instalment No.','Instalment Due','Receive Date','Receiver','Message','Actions']
            .map(h=>`<th class="border px-2 py-1">${h}</th>`).join('')}</tr>
          </thead>
          <tbody>
            ${currentData.map(row=>`
              <tr class="odd:bg-gray-50">
                ${['month','savings','profit','withdraw','total','loan','instalment','instalment_no','instalment_due','receive_date','receiver','message']
                .map(col=>`<td class="border px-2 py-1">${row[col]||''}</td>`).join('')}
                <td class="border px-2 py-1 space-x-2">
                  <button data-id="${row.id}" class="editBtn text-blue-600">Edit</button>
                  <button data-id="${row.id}" class="delBtn text-red-600">Delete</button>
                </td>
              </tr>`).join('') || `<tr><td colspan="13" class="p-4 text-center">No entries yet.</td></tr>`}
          </tbody>
        </table>
        <div id="formModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
          <form id="entryForm" class="bg-white p-4 rounded shadow-lg space-y-2">
            ${['month','savings','profit','withdraw','total','loan','instalment','instalment_no','instalment_due','receive_date','receiver','message']
            .map(col=>`
              <div>
                <label class="block">${col.replace('_',' ')}:</label>
                <input name="${col}" class="border p-1 rounded w-full"/>
              </div>`).join('')}
            <input type="hidden" name="id"/>
            <div class="text-right space-x-2">
              <button type="button" id="cancelBtn" class="px-3 py-1">Cancel</button>
              <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Save</button>
            </div>
          </form>
        </div>`;
      tableContainer.innerHTML = html;

      document.getElementById('addBtn').onclick = () => openForm();
      document.getElementById('cancelBtn').onclick = () => closeForm();

      document.querySelectorAll('.editBtn').forEach(b=>{
        b.onclick = ()=> openForm(currentData.find(r=>r.id===b.dataset.id));
      });
      document.querySelectorAll('.delBtn').forEach(b=>{
        b.onclick = ()=> deleteEntry(b.dataset.id));
      });

      document.getElementById('entryForm').onsubmit = async e=>{
        e.preventDefault();
        const form = e.target;
        const data = new FormData(form);
        const params = new URLSearchParams(data);
        params.append('action', form.id.value ? 'update' : 'create');
        params.append('member', currentMember);
        const res = await fetch(WEB_APP_URL, { method:'POST', body: params });
        const json = await res.json();
        if(json.error) return alert(json.error);
        closeForm();
        await fetchData();
        renderTable();
      };
    }

    function openForm(data={}) {
      const form = document.getElementById('entryForm');
      Object.keys(data).forEach(k=>{
        const el = form.querySelector(`[name=${k}]`);
        if(el) el.value = data[k];
      });
      document.getElementById('formModal').classList.remove('hidden');
    }
    function closeForm(){
      document.getElementById('entryForm').reset();
      document.getElementById('formModal').classList.add('hidden');
    }

    async function deleteEntry(id){
      if(!confirm('Delete this entry?')) return;
      const params = new URLSearchParams({action:'delete',member:currentMember,id});
      const res = await fetch(WEB_APP_URL, { method:'POST', body: params });
      const json = await res.json();
      if(json.error) return alert(json.error);
      await fetchData();
      renderTable();
    }
  </script>
</body>
</html>
